/**
 * Multi Split Button custom element.
 */
JQX('jqx-multi-split-button', class MultiSplitButton extends JQX.DropDownList {
    //Multi Split Button's properties.
    static get properties() {
        return {
            'buttonsDataSource': {
                value: [],
                type: 'array'
            },
            'dropDownOpenMode': {
                allowedValues: ['none', 'dropDownButton', 'auto'],
                value: 'dropDownButton',
                type: 'string'
            }
        };
    }

    template() {
        return `<div id="container">
                    <span class="jqx-label" id="label">[[label]]</span>
                    <div id="content" class="jqx-content">
                        <div id="actionButton" class ="jqx-input jqx-action-button">
                         <template>
                                 <div class="jqx-multi-split-button-buttons" *items={{buttonsDataSource}}><span class="jqx-action-split-button" inner-H-T-M-L={{item}}></span></div>
                          </template>
                        </div>
                        <span id="dropDownButton" class="jqx-drop-down-button">
                            <span id="arrow"></span>
                        </span>
                        <div id="dropDownContainer" class="jqx-drop-down jqx-drop-down-container jqx-visibility-hidden">
                            <jqx-list-box id="listBox" unfocusable
                                    animation="[[animation]]"
                                    data-source="[[dataSource]]"
                                    disabled="[[disabled]]"
                                    display-loading-indicator="[[displayLoadingIndicator]]"
                                    display-member="[[displayMember]]"
                                    filterable="[[filterable]]"
                                    filter-mode="[[filterMode]]"
                                    filter-input-placeholder="[[filterInputPlaceholder]]"
                                    grouped="[[grouped]]"
                                    group-member="[[groupMember]]"
                                    item-height="[[itemHeight]]"
                                    item-template="[[itemTemplate]]"
                                    incremental-search-delay="[[incrementalSearchDelay]]"
                                    incremental-search-mode="[[incrementalSearchMode]]"
                                    loading-indicator-placeholder="[[loadingIndicatorPlaceholder]]"
                                    loading-indicator-position="[[loadingIndicatorPosition]]"
                                    name="[[name]]"
                                    placeholder="[[dropDownPlaceholder]]"
                                    readonly="[[readonly]]"
                                    selected-indexes="{{selectedIndexes}}"
                                    selection-mode="[[selectionMode]]"
                                    selected-values="{{selectedValues}}"
                                    sorted="[[sorted]]"
                                    theme="[[theme]]"
                                    value-member="[[valueMember]]"
                                    horizontal-scroll-bar-visibility="[[horizontalScrollBarVisibility]]"
                                    vertical-scroll-bar-visibility="[[verticalScrollBarVisibility]]"
                                    virtualized="[[virtualized]]">
                                <content></content>
                            </jqx-list-box>
                            <div id="resizeBar" class="jqx-drop-down-resize-bar">
                                <div></div>
                            </div>
                         </div>
                    </div>
                    <span class="jqx-hint" id="hint">[[hint]]</span>
                </div>`;
    }

    static get listeners() {
        return {
            'actionButton.down': '_buttonsDownHandler',
            'actionButton.mouseenter': '_buttonsMouseEventsHandler',
            'actionButton.move': '_buttonsMouseEventsHandler',
            'actionButton.mouseleave': '_buttonsMouseEventsHandler',
            'dropDownButton.mouseenter': '_dropDownButtonMouseEventsHandler',
            'dropDownButton.mouseleave': '_dropDownButtonMouseEventsHandler',
            'actionButton.focus': '_focusEventHandler',
            'actionButton.blur': '_blurEventHandler',
            'dropDownButton.focus': '_focusEventHandler',
            'dropDownButton.blur': '_blurEventHandler'
        }
    }

    /**
     * ActionButton / DropDownButton Blur event handler
     */
    _blurEventHandler() {
        const that = this;

        that.removeAttribute('focus');

        if (!that._preventDropDownClose) {
            that.close();
        }
    }

    /**
     * ActionButton / DropDownButton Focus event handler
     */
    _focusEventHandler() {
        this.setAttribute('focus', '');
    }

    _documentUpHandler(event) {
        const that = this;

        super._documentUpHandler(event);

        const splitButtons = that.querySelectorAll('.jqx-action-split-button');

        for (let i = 0; i < splitButtons.length; i++) {
            const splitButton = splitButtons[i];

            splitButton.removeAttribute('active');
        }

        that.removeAttribute('active');
    }

    _dropDownButtonMouseEventsHandler(event) {
        const that = this;

        if (event.type === 'mouseleave') {
            that.$.dropDownButton.removeAttribute('hover');
            that.removeAttribute('hover');
        }
        else {
            that.$.dropDownButton.setAttribute('hover', '');
            that.setAttribute('hover', '');
        }
    }

    _buttonsDownHandler(event) {
        const that = this;

        const splitButtons = that.querySelectorAll('.jqx-action-split-button');

        for (let i = 0; i < splitButtons.length; i++) {
            const splitButton = splitButtons[i];
            const rect = splitButton.getBoundingClientRect();

            if (event.type !== 'mouseleave') {
                that.setAttribute('active', '');
                splitButtons[i].removeAttribute('active');
                if (rect.left <= event.pageX && event.pageX <= rect.width + rect.left) {
                    splitButtons[i].setAttribute('active', '');
                    that.$.fireEvent('buttonClick', {
                        'index': i,
                        'label': that.buttonsDataSource[i]
                    });
                }
            }
            else {
                splitButtons[i].removeAttribute('active');
                that.removeAttribute('active', '');
            }
        }
    }

    _buttonsMouseEventsHandler(event) {
        const that = this;

        const splitButtons = that.querySelectorAll('.jqx-action-split-button');

        for (let i = 0; i < splitButtons.length; i++) {
            const splitButton = splitButtons[i];
            const rect = splitButton.getBoundingClientRect();

            if (event.type !== 'mouseleave') {
                that.setAttribute('hover', '');
                splitButtons[i].removeAttribute('hover');
                if (rect.left <= event.pageX && event.pageX <= rect.width + rect.left) {
                    splitButtons[i].setAttribute('hover', '');
                }
            }
            else {
                splitButtons[i].removeAttribute('hover');
                that.removeAttribute('hover', '');
            }
        }
    }


    _applySelection() {
        const that = this;

        if (that.buttonsDataSource.length === 0) {
            if (that.selectionDisplayMode === 'placeholder' || that.selectedIndexes.length === 0) {
                that.querySelector('.jqx-template-container').innerHTML = that.placeholder;
                return;
            }

            if (!that.$.listBox._items || that.$.listBox._items.length === 0) {
                return;
            }

            that.querySelector('.jqx-template-container').innerHTML = '<div class="jqx-multi-split-button-buttons"><span class="jqx-action-split-button"></span></div>';
            that.$.actionButton.querySelector('.jqx-action-split-button').appendChild(that._createToken());
        }
    }

    propertyChangedHandler(propertyName, oldValue, newValue) {
        const that = this;

        if (propertyName === 'dataSource' || propertyName === 'displayMember') {
            //Check the new listBox size
            that._setDropDownSize();
            that._positionDetection.checkBrowserBounds('vertically');
            that._positionDetection.positionDropDown();
            that._positionDetection.checkBrowserBounds('horizontally');

        }
        else {
            super.propertyChangedHandler(propertyName, oldValue, newValue);
        }
    }
});
