"use strict";JQX("jqx-filter-builder",function(e){function t(){return babelHelpers.classCallCheck(this,t),babelHelpers.possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return babelHelpers.inherits(t,e),babelHelpers.createClass(t,[{key:"template",value:function(){return'<div id="container" title="[[hint]]">\n                    <div id="innerContainer" class ="jqx-inner-container">\n                            <div id="scrollableOuterContainer" class ="jqx-scrollable-outer-container">\n                                <jqx-scroll-viewer id="scrollableContainer" class ="jqx-scrollable-container" animation="[[animation]]">\n                                    <div id="contentContainer" class ="jqx-content-container"></div>\n                                </jqx-scroll-viewer>\n                            </div>\n                            <div id="editorsContainer" class ="jqx-editors-container">\n                                <div id="customEditor" class ="jqx-custom-editor jqx-hidden"></div>\n                            </div>\n                    </div>\n                    <jqx-menu id="conditionsMenu" mode="dropDown" class ="jqx-conditions-menu" theme="[[theme]]" animation="[[animation]]"></jqx-menu>\n            </div>'}},{key:"propertyChangedHandler",value:function(e,i,a){var n=this,r=["textBoxEditor","numericTextBoxEditor","comboBoxEditor","dateTimePickerEditor","checkBoxEditor"];switch(babelHelpers.get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"propertyChangedHandler",this).call(this,e,i,a),e){case"animation":case"theme":r.forEach(function(t){return n.$[t]&&(n.$[t][e]=a)});break;case"customOperations":n._handleCustomOperations(),n._refresh();break;case"fields":n._mapFieldsToMenu(),n._refresh();break;case"formatStringDate":case"formatStringDateTime":case"showIcons":case"valueFormatFunction":n._refresh();break;case"locale":case"messages":n._localizeInitialValues(),n._refresh(),n._handleCustomOperations(),n.$.dateTimePickerEditor&&(n.$.dateTimePickerEditor.messages[n.locale]||(n.$.dateTimePickerEditor.messages[n.locale]={}),n.$.dateTimePickerEditor.messages[n.locale].dateTabLabel=n.localize("dateTabLabel"),n.$.dateTimePickerEditor.messages[n.locale].timeTabLabel=n.localize("timeTabLabel"),"locale"===e?n.$.dateTimePickerEditor.locale=n.locale:"messages"===e&&(n.$.dateTimePickerEditor.$.selectDate.innerHTML=n.$.dateTimePickerEditor.messages[n.locale].dateTabLabel,n.$.dateTimePickerEditor.$.selectTime.innerHTML=n.$.dateTimePickerEditor.messages[n.locale].timeTabLabel));break;case"maxConditions":case"maxConditionsPerGroup":case"maxLevel":case"value":n._totalConditions=0,n._validateValue(),n._emptyElementsStructure(!0),n._convertValueToFlat(n.value),n._getFieldsFromValue(),n._mapFieldsToMenu(),n._generateHTMLStructureFromFlatValue(),n.$.scrollableContainer.refresh();var l=JSON.stringify(n.value);n._oldValueAsString!==l&&(n._oldValueAsString=l,n.$.fireEvent("change",{value:JSON.parse(l)}));break;case"valuePlaceholder":n._updatePlaceholder()}}},{key:"_maxValidator",value:function(e,t){return"number"!=typeof t?t:Math.max(1,t)}},{key:"ready",value:function(){babelHelpers.get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"ready",this).call(this);var e=this;e._validateValue(),e._setInitialValues(),e._handleCustomOperations(),e._emptyElementsStructure(!0),e._totalConditions=0,e._convertValueToFlat(e.value),e._getFieldsFromValue(),e._generateHTMLStructureFromFlatValue(),e.$.conditionsMenu._noAutoFocus=!0,e._oldValueAsString=JSON.stringify(e.value),setTimeout(function(){e.$.scrollableContainer.refresh()},25)}},{key:"addCondition",value:function(e,t){var i=this;i._checkFieldsExistence(),i._addElement("condition",e,t)}},{key:"addGroup",value:function(e,t){this._addElement("group",e,t)}},{key:"removeCondition",value:function(e){var t=this;t._validateNode(e,"removeCondition"),t._deleteElement(e,"condition"),t._refresh()}},{key:"removeGroup",value:function(e){var t=this;t._validateNode(e,"removeGroup"),t._deleteElement(e,"group"),t._refresh()}},{key:"toString",value:function(e){var t=this;if(!e)return JSON.stringify(t.value);for(var i=[],a=[],n=0;n<t._valueFlat.length;n++){var r=t._valueFlat[n],l={};if("condition"===r.type){var o=t._getFieldByFieldName(r.data[0]),d=o.dataType,s="["+(o.label||o.value)+"]",u=t.localize(r.data[1]),c=-1!==["boolean","number"].indexOf(d)?r.data[2]+"":"'"+r.data[2]+"'";l.data=s+" "+u+" "+c}else l.data=r.data;l.nodeId=r.nodeId,l.parentId=r.parentId,l.type=r.type,i.push(l)}for(var p=0;p<i.length;p++)!function(e){var n=i[e],r={};if("group"===n.type){var l=i.filter(function(e){return e.parentId===n.nodeId&&"condition"===e.type});if(l.length>0){var o=l.map(function(e){return e.data}),d="",s="",u=n.data;-1!==["notand","notor"].indexOf(u)&&(d="Not (",s=")",u=u.substring(3)),r.nodeId=n.nodeId,r.parentId=n.parentId,r.data=n.data,r.structure=d+o.join(" "+t.localize(u)+" ")+s,a.push(r)}}}(p);a=a.filter(function(e){return e.structure.length>1}),a.sort(function(e,t){return t.nodeId.split(".").length-e.nodeId.split(".").length});for(var v=0;v<a.length;v++)!function(e){var i=a[e],n=a.filter(function(e){return e.nodeId===i.parentId})[0];if(n&&n.structure){var r=n.data;-1!==["notand","notor"].indexOf(r)?(r=r.substring(3),n.structure=n.structure.slice(0,n.structure.length-1)+" "+t.localize(r)+" ("+i.structure+"))"):n.structure=n.structure+" "+t.localize(r)+" ("+i.structure+")"}}(v);return a[a.length-1].structure}},{key:"updateCondition",value:function(e,t){var i=this,a=i._validateNode(e,"updateCondition");i._validateUserData(t,!0),a.data=t,i._refresh()}},{key:"updateGroup",value:function(e,t){var i=this,a=i._validateNode(e,"updateGroup");i._validateUserData(t),a.data=t,i._refresh()}},{key:"_addElement",value:function(e,t,i){t=t||"0";var a=this,n=a._valueFlat.filter(function(e){return e.nodeId===t&&"group"===e.type}),r=n.length>0&&n[0],l=a._valueFlat.filter(function(e){return e.parentId===t}),o=0,d="";if(r||a.error(a.localize("wrongParentGroupIndex",{elementType:a.nodeName.toLowerCase(),method:"addGroup/addCondition"})),"group"===e)i=i||"or";else{if(l.filter(function(e){return"condition"===e.type}).length===a.maxConditionsPerGroup||a._totalConditions===a.maxConditions)return;var s=a.fields&&a.fields.length>0?a.fields[0].dataField:a._valueFields[0].dataField;a._totalConditions++,i=i||[],i[0]=i[0]||s,i[1]=i[1]||"=",i[2]=void 0!==babelHelpers.typeof(i[2])?i[2]:null}if(l){var u=l.map(function(e){var t=e.nodeId.split(".");return parseInt(t[t.length-1])});u=0===u.length?[0]:u,o=u.reduce(function(e,t){return Math.max(e,t)})+1}t&&t.length>0&&(d=".");var c=t+d+o,p={nodeId:c,parentId:t,type:e,data:i,htmlNode:null};a._valueFlat.push(p),a._refresh()}},{key:"_clearConditionsValue",value:function(e,t){for(var i=this,a=i.querySelector('[node-id="'+(e||0)+'"]'),n=a.querySelector(".jqx-value-container"),r=0;r<i._valueFlat.length;r++)i._valueFlat[r].nodeId===e&&function(){var e=i._valueFlat[r],a=t?i.fields.find(function(e){return e.dataField===t}).dataType:i.fields.find(function(t){return t.dataField===e.data[0]}).dataType;e.data[2]=i._defaultValueByType(a)}();n.innerHTML=i.valuePlaceholder,n.closest(".jqx-filter-value").setAttribute("placeholder","")}},{key:"_convertValueToFlat",value:function(e,t){var i=this,a=/^(and|or|notAnd|notOr)$/i;if(e){var n=e.filter(function(e){return"string"==typeof e&&e.match(a)}),r=n?n[0]:null,l=e.filter(function(e){return Array.isArray(e)&&3===e.length&&0===e.filter(function(e){return"string"==typeof e&&e.match(a)}).length}),o=e.filter(function(e){return!l.includes(e)&&e!==r});if(n){var d=i._lastProcessedItemInCurrentGroup.parentId?".":"",s=(i._lastProcessedItemInCurrentGroup.parentId||"")+d+(t||0);if(!i._isMaxLevelExceeded(s)){var u={nodeId:s,parentId:i._lastProcessedItemInCurrentGroup.parentId,type:"group",data:r,htmlNode:null};i._valueFlat.push(u),i._lastProcessedItemInCurrentGroup.position=0;for(var c=0;c<l.length&&l[c];c++){var p=s+"."+(i._lastProcessedItemInCurrentGroup.position||0);if(i._isMaxLevelExceeded(p))break;var v={nodeId:p,parentId:s,type:"condition",data:l[c],htmlNode:null};i._totalConditions++,i._valueFlat.push(v),i._lastProcessedItemInCurrentGroup.position++}for(var f=0;f<o.length;f++)i._lastProcessedItemInCurrentGroup.parentId=s,i._convertValueToFlat(o[f],l.length+f),i._lastProcessedItemInCurrentGroup.position++}}}}},{key:"_isMaxLevelExceeded",value:function(e){var t=this,i=t._valueFlat;if(!(null===t.maxLevel||i.length<1)){if(e)return e.split(".").length-2>=t.maxLevel;for(var a=0;a<i.length;a++){if(i[a].nodeId.split(".").length-2>t.maxLevel)return!0}}}},{key:"_clickHandler",value:function(e){var t=this,i=e.target,a=i?i.closest(".jqx-filter-group-condition"):null,n=a?a.getAttribute("node-id"):null,r=i?i.closest(".jqx-filter-group"):null,l=r?r.getAttribute("node-id"):null,o=i.closest(".jqx-filter-add-btn"),d=i.closest(".jqx-filter-delete-btn"),s=i.closest(".filter-builder-item"),u=n||l,c=t._getItemById(u),p=void 0;if(!t.disabled){if((s||d||o)&&(p=s?s.classList.contains("jqx-filter-field-name")?"fieldButton":s.classList.contains("jqx-filter-operation")?"operationButton":s.classList.contains("jqx-filter-value")?"valueButton":"groupOperationButton":o?"addButton":"deleteButton",t.$.fireEvent("itemClick",{id:c.nodeId,type:c.type,component:p,data:c.data})),d){var v=i.closest(".jqx-filter-group-operator"),f=i.closest(".jqx-filter-group-condition");return void t._clickHandlerDeleteButton(v,f,r)}if(o)return t._closeEditor(),t._contextMenuOptions=t._addOptions,void t._handleContextMenu(i);if(s){var m=s.classList;return void t._clickHandlerFilterButton(m,u,i)}t.$.conditionsMenu.opened&&(t.$.fireEvent("menuClosing"),t.$.conditionsMenu.close(),t.$.fireEvent("menuClose"));var _=i.closest(".jqx-drop-down"),h=t._editor&&t._editor.contains(i)||_&&_.ownerElement===t._editor||i.closest(".jqx-custom-editor");if(t._editorIsOpen&&t._editor&&!h)return t._scrollBarDown?void delete t._scrollBarDown:void t._closeEditor()}}},{key:"_clickHandlerDeleteButton",value:function(e,t,i){var a=this;a.$.conditionsMenu.opened&&(a.$.fireEvent("menuClosing"),a.$.conditionsMenu.close(),a.$.fireEvent("menuClose")),a._closeEditor(),e?(a._deleteElement(i,"group"),a._generateValue()):t&&(a._deleteElement(t),a._generateValue()),a.$.scrollableContainer.refresh()}},{key:"_clickHandlerFilterButton",value:function(e,t,i){function a(){var e=r.$.conditionsMenu.querySelector(".jqx-selected-menu-item");e&&e.classList.remove("jqx-selected-menu-item")}function n(e,t,i){a(),r._contextMenuOptions=0===t.length?r._defaultFilterOperationDescriptions:t,r._handleContextMenu(e);var n=i,l=r.$.conditionsMenu.querySelector('jqx-menu-item[value="'+n+'"]');r.$.conditionsMenu.opened&&l&&l.classList.add("jqx-selected-menu-item")}var r=this;if(!i.closest(".jqx-editors-container")&&(r._closeEditor(),r._editedItem=r._getItemById(t),e.contains("jqx-filter-field-name")||r._editedItem.data&&r._editedItem.data.length)){if(e.contains("jqx-filter-group-operation"))return void n(i,r._groupOperationDescriptions,r._editedItem.data);if(!e.contains("jqx-filter-add-btn")){if(e.contains("jqx-filter-field-name"))return r._fields||r._mapFieldsToMenu(),void n(i,r._fields,r._editedItem.data[0]);if(e.contains("jqx-filter-operation")){var l=r._getFieldByFieldName(r._editedItem.data[0]);if(!l)return;var o=r._filterOperationDescriptions.slice();if(l&&l.filterOperations)o=r._filterOperationDescriptions.filter(function(e){return l.filterOperations.indexOf(e.value)>-1});else{var d=void 0;switch(l.dataType){case"number":case"date":case"datetime":d=["=","<>","<",">","<=",">=","isblank","isnotblank"];break;case"boolean":d=["=","<>","isblank","isnotblank"];break;case"object":d=["isblank","isnotblank"];break;case"string":d=["contains","notcontains","startswith","endswith","=","<>","isblank","isnotblank"];break;default:d=["contains","notcontains","startswith","endswith","=","<>","<",">","<=",">=","isblank","isnotblank"]}o=r._filterOperationDescriptions.filter(function(e){return d.indexOf(e.value)>-1})}return r.showIcons&&(o=o.map(function(e){return e.label='<div class="jqx-filter-builder-icon">'+r.icons[e.value]+'</div><div class="jqx-filter-builder-menu-item">'+r.localize(e.value)+"</div>",e})),void n(i,o.slice(),r._editedItem.data[1])}return void r._openEditor(i)}n(i,r._groupOperationDescriptions)}}},{key:"_closeEditor",value:function(e){var t=this,i=void 0;if(t._editedItem&&t._editorIsOpen){if(t._editor===t.$.dateTimePickerEditor)(i=t._editor.value)&&(i=i.toDate());else if(t._editor===t.$.checkBoxEditor)i=t._editor.checked;else if(t._editor===t.$.customEditor)i=t._selectedCustomCondition.handleValue(t._editor);else{var a=t._getFieldByFieldName(t._editedItem.data[0]);i="array"===a.dataType?t._editor.value.split(","):"object"===a.dataType?JSON.parse(t._editor.value):t._editor.value}var n=t._editedItem,r=n.htmlNode,l=n.nodeId,o=t._getFieldByFieldName(n.data[0]).dataType,d=r.querySelector(".jqx-filter-value"),s=r.querySelector(".jqx-value-container"),u={value:i,valueType:o||"string",editedItem:n};if(t.$.fireEvent("editorClosing",u),t._updateValueInFlatArray(l,i,"value",o||"string"),t._generateValue(e),d.removeAttribute("edited"),t.$.editorsContainer.removeAttribute("open"),t._editor===t.$.checkBoxEditor)s.innerHTML=t._editor.checked?"true":"false";else if(t._editor===t.$.customEditor){var c=t._selectedCustomCondition.valueTemplate(t._editor);s.innerHTML=c}else s.innerHTML=t._formatValueStringRepresentation(t._editor.value,t._editedItem.data[0]);t._editor.classList.add("jqx-hidden"),t._editorIsOpen=t._enterIsPressedInEditor=!1,t.$.fireEvent("editorClose",u),t.$.scrollableContainer.refresh()}}},{key:"_defaultValueByType",value:function(e){var t=void 0;switch(e){case"number":t=0;break;case"date":case"datetime":t=new Date,t.setHours(0,0,0);break;case"boolean":t=!1;break;case"object":t=null;break;default:t=""}return t}},{key:"_deleteElement",value:function(e,t){function i(e){var t=r._valueFlat.filter(function(t){return e===t.nodeId}),i=t?t[0]:null;r._valueFlat.splice(r._valueFlat.indexOf(i),1),r._totalConditions--}function a(e){for(var t=r._valueFlat.filter(function(t){return e===t.nodeId}),n=t?t[0]:null,l=0;l<r._valueFlat.length;l++){var o=r._valueFlat[l],d=o.nodeId;o.parentId===e&&("group"===o.type?a(d):i(d))}r._valueFlat.indexOf(n)>-1&&r._valueFlat.splice(r._valueFlat.indexOf(n),1)}function n(e,t){e.forEach(function(e,i){var a=r._valueFlat.find(function(t){return t.htmlNode===e}),l=t+"."+i;e.setAttribute("node-id",l),a.parentId=t,a.nodeId=l,e.classList.contains("jqx-filter-group")&&n(Array.from(e.children[1].children),l)})}var r=this,l=e instanceof HTMLElement?e:r._valueFlat.find(function(t){return t.nodeId===e}).htmlNode,o="string"==typeof e?e:e.getAttribute("node-id");if(o&&1!==o.length){"group"===t?a(o):i(o);for(var d=r._valueFlat.length-1;d>=0;d--)!function(e){0===r._valueFlat.filter(function(t){return r._valueFlat[e].parentId===t.nodeId}).length&&"0"!==r._valueFlat[e].nodeId&&(r._valueFlat.splice(e,1),r._totalConditions--)}(d);r._generateValue(),l.parentElement.removeChild(l),n(Array.from(r.$.contentContainer.firstElementChild.children[1].children),"0")}}},{key:"_documentClickHandler",value:function(e){var t=this;e.target.closest("jqx-filter-builder")||(t.$.conditionsMenu.opened&&(t.$.fireEvent("menuClosing"),t.$.conditionsMenu.close(),t.$.fireEvent("menuClose")),t._editorIsOpen&&!t._scrollBarDown&&t._closeEditor(),delete t._scrollBarDown)}},{key:"_downHandler",value:function(e){var t=this;e.target.closest("jqx-scroll-bar")?t._scrollBarDown=!0:delete t._scrollBarDown}},{key:"_containerChangeHandler",value:function(e){e.stopPropagation()}},{key:"_emptyElementsStructure",value:function(e){for(var t=this,i=t.$.contentContainer;i.firstChild;)i.removeChild(i.firstChild);t._valueFlat=e?[]:t._valueFlat,t._lastProcessedItemInCurrentGroup={parentId:null,id:null,position:null}}},{key:"_filterGroupRow",value:function(e){e=this.localize(e||"or");var t=document.createElement("div"),i='<span class ="jqx-filter-delete-btn"></span>\n                <span class ="filter-builder-item jqx-filter-group-operation">'+e+'</span>\n                <span class ="jqx-filter-add-btn"></span>';return t.className="jqx-filter-group-operator",t.innerHTML=i,t.data=e||"or",t}},{key:"_formatValueStringRepresentation",value:function(e,t){var i=this,a=i._getFieldByFieldName(t),n=void 0;if(!a)return e;if((!e||0===e.length)&&"boolean"!==a.dataType&&"number"===a.dataType&&null===e||"string"===a.dataType&&(!e||0===e.length))return i.valuePlaceholder;switch(a.dataType){case"date":case"datetime":e?(e=function(e){return 0===e||"number"==typeof e||"string"==typeof e||!0===e||""===e||"0"===e||Array.isArray(e)||"object"===(void 0===e?"undefined":babelHelpers.typeof(e))&&e.constructor===Date?new JQX.Utilities.DateTime(e):e}(e),e.calendar.days=i._localizedDays,e.calendar.months=i._localizedMonths,e.calendar.locale=i.locale,JQX.Utilities.DateTime.cache=[],n=e.toString("date"===a.dataType?i.formatStringDate:i.formatStringDateTime)):n=i.valuePlaceholder;break;case"array":n="string"==typeof e?e.split(","):e;break;case"object":n="string"==typeof e?e:JSON.stringify(e);break;case"number":n=e;break;case"boolean":n=!1===e?"false":"true";break;default:n=e+""}return i.valueFormatFunction?i.valueFormatFunction(n,t,a.dataType||"string"):n}},{key:"_generateHTMLStructureFromFlatValue",value:function(){var e=this,t=document.createDocumentFragment();if(e._valueFlat&&0!==e._valueFlat.length)for(var i=0;i<e._valueFlat.length;i++)!function(i){var a=e._valueFlat[i],n=!!e.customOperations&&e.customOperations.find(function(e){return e.name===a.data[1]}),r=a.parentId?e.querySelector('[node-id="'+a.parentId+'"]').querySelector(".jqx-filter-group-condition-container"):e.$.contentContainer;if("group"===a.type){var l=document.createElement("div"),o=e._filterGroupRow(a.data),d=document.createElement("div");l.className="jqx-filter-group",d.className="jqx-filter-group-condition-container",l.appendChild(o),l.appendChild(d),t.appendChild(l),l.setAttribute("node-id",a.nodeId),e._valueFlat[i].htmlNode=l,e._isMaxLevelExceeded(a.nodeId+".0")&&l.setAttribute("max-level","")}else{var s=e._newFilterConditionRow(a.data);s.setAttribute("node-id",a.nodeId),t.appendChild(s),e._valueFlat[i].htmlNode=s,(-1!==["isblank","isnotblank"].indexOf(a.data[1])||n&&n.hideValue)&&s.children[3].classList.add("jqx-hidden")}r.appendChild(t)}(i)}},{key:"_generateValue",value:function(){var e=this,t=[],i=e._valueFlat.slice();!function(e){for(var i=0;i<e.length;i++){var a=e[i],n={};"group"===a.type&&(n.nodeId=a.nodeId,n.parentId=a.parentId,n.structure=[a.data||"or"],t.push(n))}for(var r=0;r<t.length;r++)!function(i){for(var a=t[i],n=e.filter(function(e){return e.parentId===a.nodeId&&"condition"===e.type}),r=0;r<n.length;r++)0===r?a.structure.unshift(n[r].data):a.structure.push(n[r].data)}(r);t=t.filter(function(e){return e.structure.length>1}),t.sort(function(e,t){return t.nodeId.split(".").length-e.nodeId.split(".").length});for(var l=0;l<t.length;l++)!function(e){var i=t[e],a=t.filter(function(e){return e.nodeId===i.parentId})[0];a&&a.structure&&a.structure.push(i.structure)}(l)}(i),t.length>0?e.value=e._valueFlat.length>1?t[t.length-1].structure:t:e.value=[e._getItemById("0").data];var a=JSON.stringify(e.value);e._oldValueAsString!==a&&(e._oldValueAsString=a,e.$.fireEvent("change",{value:JSON.parse(a)}))}},{key:"_getFieldByFieldName",value:function(e){var t=this;return(t.fields?t.fields.filter(function(t){return t.dataField===e}):t._valueFields.filter(function(t){return t.dataField===e}))[0]||null}},{key:"_getFieldsFromValue",value:function(){for(var e=this,t=e._valueFlat,i=[],a=[],n=0;n<t.length;n++)if("condition"===t[n].type){var r=t[n].data[0];if(-1===i.indexOf(r)){var l={label:r,dataField:r,dataType:"string",format:null};i.push(r),a.push(l)}}e._valueFields=a}},{key:"_getItemById",value:function(e,t){var i=this,a=i._valueFlat.filter(function(i){return t?i.parentId===e:i.nodeId===e});return a.length>0?a[0]:null}},{key:"_handleContextMenu",value:function(e){var t=this;if(t._selectedElement!==e||!t.$.conditionsMenu.opened){var i=e.getBoundingClientRect(),a=t.getBoundingClientRect(),n=i.height,r=i.left+t.$.contentContainer.scrollLeft-a.left,l=i.top+t.$.contentContainer.scrollTop-a.top+n,o=e.closest("[node-id]").getAttribute("node-id"),d=t._getItemById(o),s=null;if(e.closest(".jqx-filter-delete-btn"))s="buttonDelete";else if(e.closest(".jqx-filter-add-btn")){if(t.restrictedMode){t._checkFieldsExistence();var u=t.fields?t.fields[0]:t._valueFields[0],c=u.filterOperations&&u.filterOperations.length>0?u.filterOperations[0]:"=";return void t._addElement("condition",0,[u.dataField,c,t._defaultValueByType(u.dataType)])}s="buttonAdd"}else e.closest(".jqx-filter-group-operation")?s="groupOperation":e.closest(".jqx-filter-field-name")?s="conditionField":e.closest(".jqx-filter-operation")&&(s="conditionOperation");var p={target:e,targetX:i.left,targetY:i.top,parentGroupId:d.parentId,id:d.nodeId,type:d.type,data:d.data,targetType:s};if(t.$.conditionsMenu.opened&&(t.$.fireEvent("menuClosing"),t.$.conditionsMenu.close(),t.$.fireEvent("menuClose")),t._closeEditor(),t.disableContextMenu)return t._selectedElement=e,t.$.fireEvent("menuOpening",p),void t.$.fireEvent("menuOpen",p);t.$.fireEvent("menuOpening",p),t.$.conditionsMenu.dataSource=t._contextMenuOptions,t.$.conditionsMenu.open(r,l),t._selectedElement=e,t.$.fireEvent("menuOpen",p),t.$.scrollableContainer.refresh()}}},{key:"_handleCustomOperations",value:function(){var e=this;e._filterOperationDescriptions=e._defaultFilterOperationDescriptions;for(var t=0;t<e.customOperations.length;t++){var i=e.customOperations[t];e._filterOperationDescriptions.push({label:i.label,value:i.name,custom:!0,index:t,editorTemplate:i.editorTemplate,valueTemplate:i.valueTemplate,handleValue:i.handleValue})}}},{key:"_initializeEditor",value:function(e){var t=this,i="jqx-"+JQX.Utilities.Core.toDash(e),a=document.createElement(i);"numericTextBox"===e?(a.spinButtons=!0,a.inputFormat="floatingPoint"):"dateTimePicker"===e&&(a.calendarButton=!0,a.dropDownDisplayMode="auto",a.enableMouseWheelAction=!0,a.locale=t.locale,a.messages[t.locale]||(a.messages[t.locale]={}),a.messages[t.locale].dateTabLabel=t.localize("dateTabLabel"),a.messages[t.locale].timeTabLabel=t.localize("timeTabLabel")),a.tabIndex="1",a.theme=t.theme,a.animation=t.animation,t.$[e+"Editor"]=a,a.$=JQX.Utilities.Extend(a),a.className=i+"-editor jqx-hidden",t.$.editorsContainer.appendChild(a),t["_"+e+"Initialized"]=!0}},{key:"_innerContainerKeydownHandler",value:function(e){var t=this;"Escape"!==e.key&&"Enter"!==e.key||!t._editorIsOpen||t._closeEditor()}},{key:"_inputBlurHandler",value:function(){var e=this,t=void 0;if(e._editor===e.$.dateTimePickerEditor)(t=e._editor.value)&&(t=t.toDate());else if(e._editor===e.$.checkBoxEditor)t=e._editor.checked;else if(e._editor===e.$.customEditor)t=e._selectedCustomCondition.handleValue(e._editor);else{var i=e._getFieldByFieldName(e._editedItem.data[0]);t="array"===i.dataType?e._editor.value.split(","):"object"===i.dataType?JSON.parse(e._editor.value):e._editor.value}var a=e._editedItem,n=a.nodeId,r=e._getFieldByFieldName(a.data[0]).dataType;e._updateValueInFlatArray(n,t,"value",r||"string"),e._generateValue()}},{key:"_localizeInitialValues",value:function(){var e=this,t=JQX.Utilities.DateTime.getLocalizedNames(e.locale);e._addOptions=[{label:e.localize("addCondition"),value:"addCondition"},{label:e.localize("addGroup"),value:"addGroup"}],e._groupOperationDescriptions=[{label:e.localize("and"),value:"and"},{label:e.localize("notand"),value:"notand"},{label:e.localize("or"),value:"or"},{label:e.localize("notor"),value:"notor"}],e._defaultFilterOperationDescriptions=e._filterOperationDescriptions=[{label:e.localize("="),value:"=",custom:!1},{label:e.localize("<>"),value:"<>",custom:!1},{label:e.localize(">"),value:">",custom:!1},{label:e.localize(">="),value:">=",custom:!1},{label:e.localize("<"),value:"<",custom:!1},{label:e.localize("<="),value:"<=",custom:!1},{label:e.localize("startswith"),value:"startswith",custom:!1},{label:e.localize("endswith"),value:"endswith",custom:!1},{label:e.localize("contains"),value:"contains",custom:!1},{label:e.localize("notcontains"),value:"notcontains",custom:!1},{label:e.localize("isblank"),value:"isblank",custom:!1},{label:e.localize("isnotblank"),value:"isnotblank",custom:!1}],e._localizedDays=t.days,e._localizedMonths=t.months}},{key:"_mapFieldsToMenu",value:function(){var e=this;(e.fields||e._valueFields)&&(e._fields=(e.fields||e._valueFields).map(function(e){var t={};return t.label=e.label,t.value=e.dataField,t.dataType=e.dataType,t}))}},{key:"_menuItemClickHandler",value:function(e){var t=this,i=t._selectedElement.closest(".filter-builder-item"),a=e.detail,n=a.value,r=t.localize(n)||a.label;if(i){var l=i.closest(".jqx-filter-group-condition"),o=i.closest(".jqx-filter-group"),d=l?l.getAttribute("node-id"):o.getAttribute("node-id"),s=2;if(i.innerHTML=r,i.value=n,t._editedItem&&i.classList.contains("jqx-filter-field-name")&&t._editedItem.data[0]!==n){var u=i.parentNode.querySelector(".jqx-filter-value"),c=t.customOperations.map(function(e){if(e.hideValue)return e.name}).filter(function(e){return e}),p=c.concat(["isblank","isnotblank"]);t._clearConditionsValue(d,n),t._setInitialFilterOperation(d,n),p.indexOf(n)>-1?u.classList.add("jqx-hidden"):u.classList.remove("jqx-hidden")}if(i.classList.contains("jqx-filter-field-name"))s=0;else if(i.classList.contains("jqx-filter-operation")){var v=i.parentNode.querySelector(".jqx-filter-value"),f=void 0;if(t.customOperations){var m=t.customOperations.filter(function(e){return e.name===n});m.length>0&&(f=m[0])}["isblank","isnotblank"].indexOf(n)>-1||f&&f.hideValue?(t._clearConditionsValue(d),v.classList.add("jqx-hidden")):v.classList.remove("jqx-hidden"),s=1}else if(i.classList.contains("jqx-filter-group-operation")){for(var _=0;_<t._valueFlat.length;_++)t._valueFlat[_].nodeId===d&&(t._valueFlat[_].data=i.value);return t._generateValue(),void t.$.scrollableContainer.refresh()}for(var h=0;h<t._valueFlat.length;h++)t._valueFlat[h].nodeId===d&&(t._valueFlat[h].data[s]=i.value);return t._generateValue(),void t.$.scrollableContainer.refresh()}var g=t._selectedElement.closest(".jqx-filter-group"),b=g.getAttribute("node-id");if(!t._isMaxLevelExceeded(b+".0")){if("addCondition"===n&&(t.maxConditions&&t._totalConditions<t.maxConditions||!t.maxConditions)){t._checkFieldsExistence();var y=t.fields?t.fields[0]:t._valueFields[0],x=y.filterOperations&&y.filterOperations.length>0?y.filterOperations[0]:"=";t._addElement("condition",b,[y.dataField,x,t._defaultValueByType(y.dataType)])}else"addGroup"===n&&t._addElement("group",b,"and");t.$.scrollableContainer.refresh()}}},{key:"_setInitialFilterOperation",value:function(e,t){var i=this,a=i.fields.find(function(e){return e.dataField===t}),n=i._valueFlat.find(function(t){return t.nodeId===e}),r=n.htmlNode.getElementsByClassName("jqx-filter-operation")[0],l=a&&a.filterOperations&&a.filterOperations.length>0?a.filterOperations[0]:"=",o=i.localize(l);o||(o=i.customOperations.find(function(e){return e.name===l}).label),n.data[1]=l,r.innerHTML=o}},{key:"_checkFieldsExistence",value:function(){var e=this;e.fields&&0!==e.fields.length||e._valueFields&&0!==e._valueFields.length||e.error(e.localize("missingFields",{elementType:e.nodeName.toLowerCase()}))}},{key:"_newFilterConditionRow",value:function(e){e=e||[];var t=this,i=e[0]?e[0]:t.fields[0].dataField,a=t._formatValueStringRepresentation(e[2],e[0]),n=t.fields?t.fields.filter(function(e){return e.dataField===i}):t._valueFields.filter(function(e){return e.dataField===i}),r=n.length>0?n[0].label:e[0],l=t.localize(e[1]);!l&&t.customOperations&&t.customOperations.length>0&&(l=t.customOperations.find(function(t){return t.name===e[1]}).label);var o=document.createElement("div"),d='<span class ="jqx-filter-delete-btn"></span>\n                <span class ="filter-builder-item jqx-filter-field-name">'+r+'</span>\n                <span class ="filter-builder-item jqx-filter-operation">'+(l||"")+'</span>\n                <span class ="filter-builder-item jqx-filter-value"><span class ="jqx-value-container">'+a+"</span></span>";return o.className="jqx-filter-group-condition",o.innerHTML=d,o}},{key:"_openEditor",value:function(e){var t=this,i=e&&e.closest(".jqx-filter-group-condition")?e.closest(".jqx-filter-group-condition").getAttribute("node-id"):null,a=e.closest(".jqx-filter-value"),n=t._getItemById(i),r=n.data[0]||t.fields[0].dataField||t._valueFields[0].dataField,l=t._getFieldByFieldName(r),o=void 0;if(n?void 0===(o=n.data[2])&&(o=""):o="",l){t._editorIsOpen&&t._closeEditor(),t.$.conditionsMenu.opened&&(t.$.fireEvent("menuClosing"),t.$.conditionsMenu.close(),t.$.fireEvent("menuClose")),a.setAttribute("edited",""),t._editedItem=n;var d=t.fields||t._valueFields,s=d.filter(function(e){return e.dataField===r}),u=t._filterOperationDescriptions.filter(function(e){return e.value===n.data[1]&&e.custom}),c=s.length>0?s[0]:null,p=l.lookup&&l.lookup.dataSource?"lookup":c.dataType;0!==u.length&&u[0].editorTemplate?(t._selectedCustomCondition=u[0],t._openCustomEditor(p,o,l)):t._openEditorByFieldType(p,o,l),t.$.fireEvent("editorOpening",{value:o,type:p,editedItem:n}),setTimeout(function(){t._editor.focus(),t._editor!==t.$.numericTextBoxEditor&&t._editor!==t.$.textBoxEditor||(t.$.scrollableContainer.scrollLeft=t.$.scrollableContainer.$.scrollViewerContainer.scrollLeft,t.$.scrollableContainer.scrollTop=t.$.scrollableContainer.$.scrollViewerContainer.oldTop,t.$.scrollableContainer.$.scrollViewerContainer.scrollLeft=0,t.$.scrollableContainer.$.scrollViewerContainer.scrollTop=0,t._editor.$.input.selectionStart=t._editor.$.input.selectionEnd=t._editor.$.input.value.length),t.$.scrollableContainer.refresh(),t.$.fireEvent("editorOpen",{value:o,type:p,editedItem:n})},0),t._editor.classList.remove("jqx-hidden"),t._editorIsOpen=!0,t.$.editorsContainer.setAttribute("open",""),a.appendChild(t.$.editorsContainer),t.$.scrollableContainer.refresh()}}},{key:"_openEditorByFieldType",value:function(e,t,i){var a=this;switch(e){case"lookup":a._comboBoxInitialized||a._initializeEditor("comboBox"),a._editor=a.$.comboBoxEditor,a._editor.dataSource=i.lookup.dataSource,a._editor.dropDownAppendTo=a.$.container,a._editor.selectedValues=[t];break;case"boolean":a._checkBoxInitialized||a._initializeEditor("checkBox"),a._editor=a.$.checkBoxEditor,a._editor.checked=!!t;break;case"datetime":a._dateTimePickerInitialized||a._initializeEditor("dateTimePicker"),a._editor=a.$.dateTimePickerEditor,a._editor.formatString=a.formatStringDateTime,a._editor.dropDownAppendTo=a.$.container,a._editor.value=t;break;case"date":a._dateTimePickerInitialized||a._initializeEditor("dateTimePicker"),a._editor=a.$.dateTimePickerEditor,a._editor.formatString=a.formatStringDate,a._editor.dropDownAppendTo=a.$.container,a._editor.value=t;break;case"number":a._numericTextBoxInitialized||a._initializeEditor("numericTextBox"),t=t||0,a._editor=a.$.numericTextBoxEditor,a._editor.value=t;break;case"array":a._textBoxInitialized||a._initializeEditor("textBox"),a._editor=a.$.textBoxEditor,a._editor.value=t.toString();break;case"object":a._textBoxInitialized||a._initializeEditor("textBox"),t=t||{},a._editor=a.$.textBoxEditor,a._editor.value=JSON.stringify(t);break;default:a._textBoxInitialized||a._initializeEditor("textBox"),a._editor=a.$.textBoxEditor,a._editor.value=t+""}}},{key:"_openCustomEditor",value:function(e,t,i){var a=this,n=a.customOperations[a._selectedCustomCondition.index].editorTemplate(e,t,i);a.$.customEditor.innerHTML="",n&&a.$.customEditor.appendChild(n),a._editor=a.$.customEditor}},{key:"_refresh",value:function(){var e=this;e._generateValue(),e._emptyElementsStructure(),e._generateHTMLStructureFromFlatValue(),e.$.scrollableContainer.refresh()}},{key:"_resizeHandler",value:function(){this.$.scrollableContainer.refresh()}},{key:"_scrollViewerWheelHandler",value:function(e){var t=this
;"wheel"===e.type&&t.$.scrollableContainer.scrollHeight&&(e.stopPropagation(),e.preventDefault())}},{key:"_setInitialValues",value:function(){var e=this;e._mapFieldsToMenu(),e._localizeInitialValues(),e.$.conditionsMenu.dropDownAppendTo=e.$.container,e.$.conditionsMenu.dataSource=e._groupOperationDescriptions,e._valueFlat=[],e._lastProcessedItemInCurrentGroup={parentId:null,id:null,position:null}}},{key:"_updatePlaceholder",value:function(){for(var e=this,t=0;t<e._valueFlat.length;t++){var i=e._valueFlat[t];"condition"!==i.type||null!==i.data[2]&&""!==i.data[2]||(i.htmlNode.querySelector(".jqx-value-container").innerHTML=e.valuePlaceholder)}e.$.textBoxEditor&&(e.$.textBoxEditor.placeholder=e.valuePlaceholder)}},{key:"_updateValueInFlatArray",value:function(e,t,i,a){var n=this;if(e&&!n.disabled){if(a=a||"string",i=i||"value",null!==t)switch(a){case"number":t=parseFloat(t);break;case"boolean":t=!!t;break;case"string":t+=""}for(var r=0;r<n._valueFlat.length;r++)if(n._valueFlat[r].nodeId===e)switch(i){case"column":n._valueFlat[r].data[0]=t;break;case"filterCondition":n._valueFlat[r].data[1]=t;break;case"value":n._valueFlat[r].data[2]=t;break;case"groupCondition":n._valueFlat[r].data=t}}}},{key:"_validateNode",value:function(e,t){var i=this,a=void 0;return e instanceof HTMLElement?a=i._getItemById(e.getAttribute("node-id")):"string"==typeof e?a=i._getItemById(e):i.error(i.localize("wrongElementNode",{elementType:i.nodeName.toLowerCase(),method:t})),a||i.error(i.localize("wrongElementNode",{elementType:i.nodeName.toLowerCase(),method:t})),a}},{key:"_validateUserData",value:function(e,t){var i=this;if(t)(!Array.isArray(e)||e.length<3)&&i.error(i.localize("invalidDataStructure",{elementType:i.nodeName.toLowerCase()}));else{var a=/^(and|or|notAnd|notOr)$/i;"string"==typeof e&&e.match(a)||i.error(i.localize("invalidDataStructure",{elementType:i.nodeName.toLowerCase()}))}}},{key:"_validateValue",value:function(){function e(e){return 3===e.length&&"string"==typeof e[0]&&"string"==typeof e[1]}function t(i,o,d){var s=0;i.forEach(function(i){if(Array.isArray(i))if(e(i)){if(null!==a&&a===l||null!==n&&n===s)return;d.push(i),s++,l++}else{if(null!==r&&r===o+1)return;var u=[];d.push(u),t(i,o+1,u)}else d.push(i)})}var i=this,a=i.maxConditions,n=i.maxConditionsPerGroup,r=i.maxLevel,l=0;if(null!==a||null!==n||null!==r){var o=i.value,d=[];t(o,0,d),i.value=d}}}],[{key:"properties",get:function(){return{customOperations:{value:[],type:"array",reflectToAttribute:!1},disableContextMenu:{value:!1,type:"boolean"},fields:{value:null,type:"array?",reflectToAttribute:!1},formatStringDate:{value:"dd-MMM-yy",type:"string"},formatStringDateTime:{value:"dd-MMM-yy HH:mm:ss",type:"string"},hint:{value:null,type:"string?"},icons:{value:{"=":"=","<>":"≠",">":">",">=":"≥","<":"<","<=":"≤",startswith:"a|bc",endswith:"ab|c",contains:"abc",notcontains:"!abc",isblank:"○",isnotblank:"●"},type:"object",reflectToAttribute:!1},maxConditions:{value:null,type:"number?",validator:"_maxValidator"},maxConditionsPerGroup:{value:null,type:"number?",validator:"_maxValidator"},maxLevel:{value:null,type:"number?",validator:"_maxValidator"},messages:{value:{en:{add:"Add",addCondition:"Add Condition",addGroup:"Add Group",and:"And",notand:"Not And",or:"Or",notor:"Not Or","=":"Equals","<>":"Does not equal",">":"Greater than",">=":"Greater than or equal to","<":"Less than","<=":"Less than or equal to",startswith:"Starts with",endswith:"Ends with",contains:"Contains",notcontains:"Does not contain",isblank:"Is blank",isnotblank:"Is not blank",wrongParentGroupIndex:'{{elementType}}: Wrong parent group index in "{{method}}" method.',missingFields:'{{elementType}}: Fields are required for proper condition\'s adding. Set "fields" source and then conditions will be added as expected.',wrongElementNode:'{{elementType}}: Incorect node / node Id in "{{method}}" method.',invalidDataStructure:"{{elementType}}: Used invalid data structure in updateCondition/updateGroup method.",dateTabLabel:"DATE",timeTabLabel:"TIME"}},type:"object",extend:!0},restrictedMode:{value:!1,type:"boolean"},showIcons:{value:!1,type:"boolean"},value:{value:["or"],type:"array?",reflectToAttribute:!1},valueFormatFunction:{value:null,type:"function?",reflectToAttribute:!1},valuePlaceholder:{value:"&lt;enter a value&gt;",type:"string"}}}},{key:"requires",get:function(){return{"JQX.Button":"jqxbutton.js","JQX.CheckBox":"jqxcheckbox.js","JQX.ScrollBar":"jqxscrollbar.js","JQX.ListBox":"jqxlistbox.js","JQX.DropDownList":"jqxdropdownlist.js","JQX.ComboBox":"jqxcombobox.js","JQX.Calendar":"jqxcalendar.js","JQX.TimePicker":"jqxtimepicker.js","JQX.Tooltip":"jqxtooltip.js","JQX.Utilities.DateTime":"jqxdate.js","JQX.DateTimePicker":"jqxdatetimepicker.js","JQX.Menu":"jqxmenu.js"}}},{key:"listeners",get:function(){return{click:"_clickHandler",down:"_downHandler","document.click":"_documentClickHandler","conditionsMenu.itemClick":"_menuItemClickHandler","container.change":"_containerChangeHandler","scrollableContainer.wheel":"_scrollViewerWheelHandler","scrollableOuterContainer.resize":"_resizeHandler","innerContainer.keydown":"_innerContainerKeydownHandler"}}}]),t}(JQX.BaseElement)),JQX("jqx-query-builder",function(e){function t(){return babelHelpers.classCallCheck(this,t),babelHelpers.possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return babelHelpers.inherits(t,e),babelHelpers.createClass(t,[{key:"template",value:function(){return'<div id="container">\n                    <jqx-scroll-viewer id="scrollableContainer" class ="jqx-scrollable-container" animation="[[animation]]">\n                        <div id="queryLabel" class="jqx-query-builder-label jqx-unselectable"></div>\n                        <div id="contentContainer" class ="jqx-content-container"></div>\n                    </jqx-scroll-viewer>\n                    <div id="editorsContainer" class ="jqx-editors-container">\n                        <div id="customEditor" class ="jqx-custom-editor jqx-hidden"></div>\n                    </div>\n                    <jqx-menu id="conditionsMenu" mode="dropDown" class ="jqx-conditions-menu" theme="[[theme]]" animation="[[animation]]"></jqx-menu>\n                </div>'}},{key:"propertyChangedHandler",value:function(e,i,a){babelHelpers.get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"propertyChangedHandler",this).call(this,e,i,a);var n=this;switch(e){case"animation":case"theme":["textBoxEditor","numericTextBoxEditor","comboBoxEditor","dateTimePickerEditor","checkBoxEditor"].forEach(function(t){return n.$[t]&&(n.$[t][e]=a)});break;case"formatStringDate":case"formatStringDateTime":case"valueFormatFunction":n._refresh();break;case"operatorPlaceholder":Array.from(n.querySelectorAll(".jqx-filter-operation[placeholder]")).forEach(function(e){return e.firstElementChild.innerHTML=a});break;case"propertyPlaceholder":Array.from(n.querySelectorAll(".jqx-filter-field-name[placeholder]")).forEach(function(e){return e.firstElementChild.innerHTML=a});break;case"showIcons":n._closeEditor(),a?n._filterOperationDescriptions.map(function(e){return e.icon=n.icons[e.value]}):n._filterOperationDescriptions.map(function(e){return delete e.icon});break;case"customOperations":case"fields":case"value":var r=JSON.stringify(n._validValue);"customOperations"===e?n._handleCustomOperations():""===e&&n._mapFieldsToMenu(),n._applyValue(),n._oldValueAsString!==r&&(n._oldValueAsString=r,n.$.fireEvent("change",{value:JSON.parse(r)}));break;case"valuePlaceholder":Array.from(n.querySelectorAll(".jqx-filter-value[placeholder]")).forEach(function(e){return e.firstElementChild.innerHTML=a});break;case"locale":case"messages":n._localizeInitialValues(),n._refresh(),n._handleCustomOperations(),n.$.dateTimePickerEditor&&(n.$.dateTimePickerEditor.messages[n.locale]||(n.$.dateTimePickerEditor.messages[n.locale]={}),n.$.dateTimePickerEditor.messages[n.locale].dateTabLabel=n.localize("dateTabLabel"),n.$.dateTimePickerEditor.messages[n.locale].timeTabLabel=n.localize("timeTabLabel"),"locale"===e?n.$.dateTimePickerEditor.locale=n.locale:"messages"===e&&(n.$.dateTimePickerEditor.$.selectDate.innerHTML=n.$.dateTimePickerEditor.messages[n.locale].dateTabLabel,n.$.dateTimePickerEditor.$.selectTime.innerHTML=n.$.dateTimePickerEditor.messages[n.locale].timeTabLabel));break;case"icons":n._closeEditor()}}},{key:"ready",value:function(){babelHelpers.get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"ready",this).call(this);var e=this;e._setInitialValues(),e._handleCustomOperations(),e._applyValue(),Object.defineProperty(e,"value",{get:function(){return e.context===e?e.properties.value.value:e._validValue},set:function(t){e.updateProperty(e,e._properties.value,t)}})}},{key:"_setInitialValues",value:function(){var e=this;e._autoScrollCoefficient=JQX.Utilities.Core.Browser.Firefox?4:JQX.Utilities.Core.Browser.Edge?8:2,e._isMobile=JQX.Utilities.Core.isMobile,e._manuallyAddedFields=[],e._localizeInitialValues(),e.$.conditionsMenu.dropDownAppendTo=e.$.container,e.$.conditionsMenu.dataSource=e._groupOperationDescriptions,e._valueFlat=[],e._lastProcessedItemInCurrentGroup={parentId:null,id:null,position:null}}},{key:"_applyValue",value:function(){var e=this;e._emptyElementsStructure(!0),e._validateValue(),e._convertValueToFlat(e.value),e._getFieldsFromValue(),e._mapFieldsToMenu(),e._generateHTMLStructureFromFlatValue(!0),e._restrictNesting(),e._validValue=e._getValidValue(),e._oldValueAsString=JSON.stringify(e._validValue)}},{key:"_setRequiredFields",value:function(){var e=this;if(e.requiredFields&&e.requiredFields.length){for(var t=e.value,i=[],a=0;a<e.requiredFields.length;a++)!function(a){var n=e.requiredFields[a],r=e.fields.find(function(e){return e.dataField===n});if(r){var l=[];if(t)for(var o=0;o<t.length;){var d=t[o];if(Array.isArray(d))for(var s=0;s<d.length;){var u=d[s];u&&u[0]===r.dataField?(l.push(u),d.splice(s>0?s-1:s,2)):s++}d.length?o++:t.splice(o,2)}if(l)for(var c=0;c<l.length;c++)i.push(l[c]),i.push("and");else i.push([n]),i.push("and")}}(a);"string"==typeof i[i.length-1]&&i.pop(),e.value.unshift(i,"and")}}},{key:"_contentContainerChangeHandler",value:function(e){var t=this;if(e.stopPropagation(),"immediately"===t.applyMode&&t._editorIsOpen&&t._editor){t._editor.closest(".filter-builder-item").classList.contains("jqx-filter-value")||t._closeEditor()}}},{key:"_mapFieldsToMenu",value:function(){var e=this;(e.fields||e._valueFields)&&(e._fields=(e.fields||e._valueFields).concat(e._manuallyAddedFields).map(function(e){return{label:e.label,value:e.dataField,dataType:e.dataType,filterOperations:e.filterOperations,lookup:e.lookup}}))}},{key:"_localizeInitialValues",value:function(){var e=this;e.$.queryLabel.innerHTML=e.localize("queryLabel"),e._addOptions=[{label:e.localize("addCondition"),value:"addCondition"},{label:e.localize("addGroup"),value:"addGroup"}],e._groupOperationDescriptions=[{label:e.localize("and"),value:"and"},{label:e.localize("or"),value:"or"}],e._defaultFilterOperationDescriptions=e._filterOperationDescriptions=[{label:e.localize("="),value:"=",custom:!1},{label:e.localize("<>"),value:"<>",custom:!1},{label:e.localize(">"),value:">",custom:!1},{label:e.localize(">="),value:">=",custom:!1},{label:e.localize("<"),value:"<",custom:!1},{label:e.localize("<="),value:"<=",custom:!1},{label:e.localize("startswith"),value:"startswith",custom:!1},{label:e.localize("endswith"),value:"endswith",custom:!1},{label:e.localize("contains"),value:"contains",custom:!1},{label:e.localize("notcontains"),value:"notcontains",custom:!1},{label:e.localize("isblank"),value:"isblank",custom:!1},{label:e.localize("isnotblank"),value:"isnotblank",custom:!1}];var t=JQX.Utilities.DateTime.getLocalizedNames(e.locale);e._localizedDays=t.days,e._localizedMonths=t.months}},{key:"_handleCustomOperations",value:function(){var e=this;e._filterOperationDescriptions=e._defaultFilterOperationDescriptions.slice(0);for(var t=0;t<e.customOperations.length;t++){var i=e.customOperations[t];e._filterOperationDescriptions.push({label:i.label,value:i.name,custom:!0,index:t,editorTemplate:i.editorTemplate,valueTemplate:i.valueTemplate,handleValue:i.handleValue,hideValue:i.hideValue})}}},{key:"_innerContainerKeydownHandler",value:function(e){var t=this;!t._editorIsOpen||"Escape"!==e.key&&"Enter"!==e.key||t._closeEditor()}},{key:"_documentDownHandler",value:function(e){var t=this,i=e.originalEvent.target;if(!i.closest(".jqx-input-drop-down-menu")&&!t.$.conditionsMenu.contains(i)){var a=i.closest(".jqx-drop-down");if(i.closest("jqx-query-builder")===t||a&&t.contains(a.ownerElement))return void t._clickHandler(e.originalEvent);t._editorIsOpen&&!t._scrollBarDown&&t._closeEditor(),delete t._scrollBarDown}}},{key:"_emptyElementsStructure",value:function(e){for(var t=this,i=t.$.contentContainer;i.firstChild;)i.removeChild(i.firstChild);t._valueFlat=e?[]:t._valueFlat,t._lastProcessedItemInCurrentGroup={parentId:null,id:null,position:null}}},{key:"_resizeHandler",value:function(){this.$.scrollableContainer.refresh()}},{key:"_getTotalConditions",value:function(){return this.getElementsByClassName("jqx-filter-group-condition").length}},{key:"_validateValue",value:function(){var e=this,t=e.value;if(!Array.isArray(t)||""===JSON.stringify(t).replace(/[\[\]]/g,""))return void(e.value=[[[]]]);for(3===t.length&&"string"==typeof t[0]&&(e.value=[[t]]),Array.isArray(t[0])&&3===t[0].length&&"string"==typeof t[0][0]&&(e.value=[t]);"string"==typeof t[0];)t.shift();for(;"string"==typeof t[t.length-1];)t.pop();e.value.forEach(function(e){Array.isArray(e)&&0===e.length&&e.push([])})}},{key:"_convertValueToFlat",value:function(e){function t(e,l){for(var o=void 0,d=0;d<e.length;d++){var s=e[d],u="string"==typeof s&&a.indexOf(s)>-1,c={htmlNode:null};if(u)o=s.trim();else if(o=o||"and",Array.isArray(s)){var p=i._valueFlat.filter(function(e){return e.parentId+""==l+""}).length;if(s.find(function(e){return Array.isArray(e)}))c.nodeId=(r+=1)+"",c.type="group",c.data=o,i._valueFlat.push(c),t(s,c.nodeId),o="";else{if(i.maxConditions&&n>=i.maxConditions||i.maxConditionsPerGroup&&p>=i.maxConditionsPerGroup)continue;0!==d&&(i._valueFlat.push({nodeId:l+"."+p,type:"operator",data:o,parentId:l+""}),o="",p++),c.nodeId=l+"."+p,c.parentId=l+"",c.type="condition",c.data=s,n++,i._valueFlat.push(c)}}}}var i=this,a=["and","or","notAnd","notOr"];if(e){var n=0,r=0;i._valueFlat=[],t(e,0),delete i._totalGroups}}},{key:"_getFieldsFromValue",value:function(){for(var e=this,t=e._valueFlat,i=[],a=[],n=0;n<t.length;n++){var r=t[n];if("condition"===r.type){var l=r.data[0];if(l&&-1===i.indexOf(l)){var o={label:l,dataField:l,dataType:function(e){return"boolean"==typeof e?"boolean":e instanceof Date?e.getHours()>0||e.getMinutes()>0||e.getSeconds()>0?"datetime":"date":isNaN(e)?"string":"number"}(r.data[2]),format:null};i.push(l),a.push(o)}}}e._valueFields=a}},{key:"_addElement",value:function(e,t,i,a){var n=this,r=n._valueFlat.filter(function(e){return e.parentId===t}),l=0,o="";if(i=i||("group"===e?"or":[]),r.length){var d=r.map(function(e){var t=e.nodeId.split(".");return parseInt(t[t.length-1])});d=0===d.length?[0]:d,l=d.reduce(function(e,t){return Math.max(e,t)})+1}t&&t.length>0&&(o=".");var s=(t||"")+o+("group"===e?n._valueFlat.filter(function(e){return"group"===e.type}).length+1:l),u=r[0];if(r.length)for(var c=0;c<r.length;c++){var p=r[c],v=p.nodeId.split(".").pop();parseInt(v)>parseInt(u.nodeId.split(".").pop())&&(u=p)}else u=n._valueFlat.find(function(e){return e.nodeId===t});var f=u?n._valueFlat.indexOf(u)+1:n._valueFlat.length;"condition"===e&&r.length>0&&(n._valueFlat.splice(f,0,{nodeId:s,parentId:t,type:"operator",data:["and"],htmlNode:null}),s=(t||"")+o+(l+1),f++);var m={nodeId:s,parentId:t,type:e,data:i,htmlNode:null};n._valueFlat.splice(f,0,m),"group"===e&&n._addElement("condition",s,[],!0),a||n._refresh()}},{key:"_deleteElement",value:function(e,t){function i(e){var t=r._valueFlat[e];if(t&&"operator"===t.type)return r._valueFlat.splice(e,1),t.htmlNode.parentElement.removeChild(t.htmlNode),!0}function a(e){var t=void 0,a=0,n=e.split(".");n.pop(),n=n.join(".");for(var l=0;l<r._valueFlat.length;l++){var o=r._valueFlat[l];if("condition"===o.type){if(o.nodeId===e){t=o;break}o.parentId===n&&a++}}var d=r._valueFlat.indexOf(t);r._valueFlat.splice(d,1),t.htmlNode.parentElement.removeChild(t.htmlNode);var s=i(d-1);a||i(d-(s?1:0));var u=r._valueFlat.filter(function(e){return e.nodeId===n})[0].htmlNode;u.children[1].childElementCount>0&&u.children[2].hasAttribute("limit-selection")&&!u.children[1].lastElementChild.hasAttribute("limit-selection")&&u.children[2].removeAttribute("limit-selection")}function n(e){for(var t=r._valueFlat.filter(function(t){return e===t.nodeId&&"group"===t.type})[0],i=0;i<r._valueFlat.length;i++){var l=r._valueFlat[i],o=l.nodeId;l.parentId===e&&("group"===l.type?n(o):a(o))}r._valueFlat.indexOf(t)>-1&&r._valueFlat.splice(r._valueFlat.indexOf(t),1),t.htmlNode.parentElement.removeChild(t.htmlNode)}var r=this,l="string"==typeof e?e:e.getAttribute("node-id");if(l&&1!==l.length&&("group"===t?n(l):a(l),!t||"condition"===t)){var o=l.split(".");if(o.pop(),o=o.join("."),!r._valueFlat.filter(function(e){return e.parentId===o}).length&&(r._valueFlat.filter(function(e){return"group"===e.type}).length>1&&n(o),"0"===o)){var d=r._valueFlat.find(function(e){return"group"===e.type}),s=d.nodeId;d.nodeId="0",d.htmlNode.setAttribute("node-id","0");for(var u=r._valueFlat.filter(function(e){return e.parentId===s}),c=0;c<u.length;c++){var p=u[c];p.parentId="0",p.nodeId="0."+c,p.htmlNode.setAttribute("node-id",p.nodeId)}}r._generateValue()}}},{key:"_generateHTMLStructureFromFlatValue",value:function(e){var t=this,i=document.createDocumentFragment();if(t._valueFlat&&0!==t._valueFlat.length){for(var a=0;a<t._valueFlat.length;a++)!function(e){var a=t._valueFlat[e],n=!!t.customOperations&&t.customOperations.find(function(e){return e.name===a.data[1]}),r=a.parentId?t.querySelector('[node-id="'+a.parentId+'"]').querySelector(".jqx-filter-group-condition-container"):t.$.contentContainer;if("group"===a.type){var l=document.createElement("div"),o=t.localize(a.data)||"";l.className="jqx-filter-group",l.innerHTML='<div class="jqx-filter-group-operator">'+o+'</div><div class="jqx-filter-group-condition-container"></div><div class="jqx-filter-add-condition-btn"><div>'+t.localize("add")+'</div></div><div class="jqx-filter-add-btn"></div>',l.firstElementChild.data=o,i.appendChild(l),l.setAttribute("node-id",a.nodeId),t._valueFlat[e].htmlNode=l}else if("condition"===a.type){var d=t._newFilterConditionRow(a.data);if(d.setAttribute("node-id",a.nodeId),i.appendChild(d),t._valueFlat[e].htmlNode=d,void 0!==a.data[0]&&void 0===a.data[1]){var s=t._getFilterOperations(t._fields.find(function(e){return e.value===a.data[0]}));t._handleOnlyOperation(s,a.data,d)}else(-1!==["isblank","isnotblank"].indexOf(a.data[1])||n&&n.hideValue)&&(a.data.splice(2,1),d.children[2].classList.add("jqx-visibility-hidden"))}else{var u=document.createElement("div");u.className="jqx-filter-nested-operator",u.setAttribute("node-id",a.nodeId),u.innerHTML=t.localize(a.data),i.appendChild(u),t._valueFlat[e].htmlNode=u}r.appendChild(i)}(a);e&&t._validateValueAdvanced(),t.$.scrollableContainer.refresh()}}},{key:"_validateValueAdvanced",value:function(){for(var e=this,t=e.value,i=!1,a=!1,n=0,r=0;r<t.length;r++){var l=t[r];if("string"!=typeof l)for(var o=l.length-1;o>=0;o--){var d=l[o];if(Array.isArray(d)&&0===d.length&&o!==l.length-1)l.splice(o,1),0===o&&l.splice(0,1),i=!0;else if("string"==typeof d){d=d.toLowerCase(),n++,(n>1||"and"!==d&&"or"!==d)&&(a=!0);continue}n=0}}i&&(e._emptyElementsStructure(!0),e._convertValueToFlat(e.value),e._generateHTMLStructureFromFlatValue()),a&&e._generateValue(!0)}},{key:"_restrictNesting",value:function(){var e=this;Array.from(e.getElementsByClassName("jqx-filter-add-condition-btn")).forEach(function(e){var t=e.previousElementSibling.lastElementChild;t&&t.hasAttribute("limit-selection")&&e.setAttribute("limit-selection","")})}},{key:"_clickHandler",value:function(e){var t=this,i=e.target;if(!t.disabled&&i&&i.closest&&(t._isMobile||0===e.button)){if(t._scrollBarDown)return void delete t._scrollBarDown;var a=i.closest(".jqx-drop-down"),n=t._editor&&t._editor.contains(i)||a&&(t._editor.contains(a.ownerElement)||t._editor===a.ownerElement)||i.closest(".jqx-custom-editor");t._editor&&t._editorIsOpen&&!n&&t._closeEditor();var r=i.closest(".jqx-filter-group-condition")||i.closest(".jqx-filter-nested-operator")||i.closest(".jqx-filter-group");if(r){var l=t._getItemById(r.getAttribute("node-id"));if(l){if(t.$.fireEvent("itemClick",{id:l.nodeId,type:l.type,data:l.data}),i.closest(".jqx-filter-delete-btn"))return void t._clickHandlerDeleteButton(l.htmlNode);var o=i.closest(".jqx-filter-add-btn")||i.closest(".jqx-filter-add-condition-btn");if(o){var d=o.closest(".jqx-filter-group").getAttribute("node-id");return void(o.classList.contains("jqx-filter-add-condition-btn")&&(t.maxConditions&&t._getTotalConditions()<t.maxConditions||!t.maxConditions)?t._addElement("condition",d,[]):t._clickHandlerFilterButton(o.classList,l.nodeId,i))}var s=i.closest(".filter-builder-item")||i.closest(".jqx-filter-group-operator")||i.closest(".jqx-filter-nested-operator");if(s){var u=s.classList;t._clickHandlerFilterButton(u,l.nodeId,i)}}}}}},{key:"_downHandler",value:function(e){var t=this;if(e.originalEvent&&(t._isMobile||0===e.button)){var i=e.originalEvent.target;if(t.allowDrag&&i.classList.contains("jqx-filter-group-condition")&&e.pageX<i.getBoundingClientRect().left){var a=t._valueFlat.filter(function(e){return"condition"===e.type});if(1===a.length||2===a.length&&a[0].parentId===a[1].parentId&&a[1].htmlNode.hasAttribute("limit-selection"))return;return t._dragDetails={coords:{x:e.pageX,y:e.pageY},item:i,originalEvent:e},t.$.scrollableContainer._scrollView.disableSwipeScroll=!0,t._hoveredCondition=i,void window.getSelection().removeAllRanges()}this._scrollBarDown=i.closest("jqx-scroll-bar"),e.stopPropagation(),e.preventDefault()}}},{key:"_moveHandler",value:function(e){"touchmove"===e.originalEvent.type&&e.originalEvent.preventDefault()}},{key:"_documentMoveHandler",value:function(e){var t=this,i=t._dragDetails;if(i){var a=i.item;if(!i.feedbackShown){if(!(Math.abs(i.coords.x-e.pageX)>5||Math.abs(i.coords.y-e.pageY)>5))return;var n=t._valueFlat.filter(function(e){return e.htmlNode===a})[0];if(t.$.fireEvent("dragStart",{data:n.data,item:a,originalEvent:e}).defaultPrevented)return delete t._dragDetails,delete t._hoveredCondition,void(t.$.scrollableContainer._scrollView.disableSwipeScroll=!1);i.allConditions=Array.from(t.getElementsByClassName("jqx-filter-group-condition")),i.data=n,i.feedback=t._addDragFeedback(),i.feedbackShown=!0,i.rect=t.getBoundingClientRect(),a.classList.add("dragged")}var r=e.clientY,l=e.originalEvent.target,o=void 0;if(t.$.fireEvent("dragging",{data:i.data,item:a,originalEvent:e}),t.setAttribute("dragging",""),i.feedback.style.left=e.pageX+10+"px",i.feedback.style.top=e.pageY+10+"px",t._isMobile){var d=t._hoveredCondition;d&&(d.classList.remove("drop-target","top","bottom"),delete t._hoveredCondition);var s=document.elementFromPoint(e.clientX,r);s&&(l=s)}var u=l.closest(".jqx-filter-group-condition"),c=void 0;if(u){o=u;var p=o.getBoundingClientRect(),v=Math.abs(r-p.top),f=Math.abs(r-p.bottom);c=v<f?"top":"bottom"}else{var m=void 0,_=void 0;i.allConditions.forEach(function(e){var t=e.getBoundingClientRect(),i=Math.abs(r-t.top),a=Math.abs(r-t.bottom),n=Math.min(i,a);(void 0===_||n<_)&&(m=e,_=n,c=i<a?"top":"bottom")}),u=m}if(u===a||u.hasAttribute("limit-selection")&&"bottom"===c)u=void 0;else{var h=Array.from(u.parentElement.getElementsByClassName("jqx-filter-group-condition")),g=h.indexOf(a);-1!==g&&("top"===c&&u===h[g+1]||"bottom"===c&&u===h[g-1])&&(u=void 0)}if(o=u,i.side=c,clearInterval(t._dragInterval),t._dragInterval=setInterval(function(){var a=i.rect;t.$.scrollableContainer.scrollHeight>0&&a.left<=e.clientX&&a.left+a.width>=e.clientX?r>=a.top&&r<=a.top+36?t.$.scrollableContainer.scrollTop-=t._autoScrollCoefficient:r>=a.top+a.height-36&&r<=a.top+a.height?t.$.scrollableContainer.scrollTop+=t._autoScrollCoefficient:clearInterval(t._dragInterval):clearInterval(t._dragInterval)},1),o){t._hoveredCondition&&o!==t._hoveredCondition&&t._hoveredCondition.classList.remove("drop-target","top","bottom");var b=o.closest(".jqx-filter-group");if(b&&b.hasAttribute("restricted"))return void(t._hoveredCondition=void 0);t._hoveredCondition=o,o.classList.remove("top","bottom"),o.classList.add(c,"drop-target")}else t._hoveredCondition&&(t._hoveredCondition.classList.remove("drop-target","top","bottom"),delete t._hoveredCondition)}}},{key:"_addDragFeedback",value:function(){var e=document.createElement("div");return e.className="jqx-query-builder-drag-feedback",document.body.appendChild(e),e}},{key:"_documentUpHandler",value:function(e){var t=this,i=t._dragDetails;if(!i)return void(t.$.conditionsMenu.opened&&t._selectedElement&&!t._selectedElement.classList.contains("jqx-filter-add-btn")&&t.$.conditionsMenu._hoverViaKeyboard(t.$.conditionsMenu.querySelector('jqx-menu-item[value="'+t._editedItem.data+'"]')));var a=i.item,n=i.data,r=t._hoveredCondition;if(delete t._dragDetails,delete t._hoveredCondition,t.$.scrollableContainer._scrollView.disableSwipeScroll=!1,t.hasAttribute("dragging")){if(clearInterval(t._dragInterval),window.getSelection().removeAllRanges(),t.removeAttribute("dragging"),a.classList.remove("dragged"),document.body.removeChild(i.feedback),!r)return void t.$.fireEvent("dragEnd",{data:n.data,item:a,originalEvent:e,target:null,targetData:null,targetSide:null});var l=t._valueFlat.filter(function(e){return e.htmlNode===r})[0],o=t.$.fireEvent("dragEnd",{data:n.data,item:a,originalEvent:e,target:r,targetData:l.data,targetSide:i.side});if(r.classList.remove("drop-target","top","bottom"),!o.defaultPrevented){var d=t.value,s=n.nodeId.split(".").map(function(e){return parseFloat(e)}),u=d[2*(s[0]-1)],c=l.nodeId.split(".").map(function(e){return parseFloat(e)}),p=d[2*(c[0]-1)],v="and";u.length>1&&(0===s[1]?(v=u[1],u[1]="!remove!"):(v=u[s[1]-1],u[s[1]-1]="!remove!")),u[s[1]]="!remove!","top"===i.side?p.splice(c[1],0,n.data,v):p.splice(c[1]+1,0,v,n.data);for(var f=0;f<d.length;f++)Array.isArray(d[f])&&(d[f]=d[f].filter(function(e){return"!remove!"!==e}));for(var m=d.length-1;m>=0;m--)Array.isArray(d[m])&&0===d[m].length&&(0===m?d.splice(0,2):(d.splice(m-1,2),m--));t._emptyElementsStructure(!0),t._convertValueToFlat(d),t._generateHTMLStructureFromFlatValue(),t._validValue=t._getValidValue();var _=JSON.stringify(t._validValue);t._oldValueAsString!==_&&(t._oldValueAsString=_,t.$.fireEvent("change",{value:JSON.parse(_)}))}}}},{key:"_clickHandlerDeleteButton",value:function(e,t){var i=this;if(e&&e.classList){if(i._closeEditor(),1===i.getElementsByClassName("jqx-filter-group-condition").length){var a=i._valueFlat[1].htmlNode.children;i.value=[[[]]],i._validValue=i._getValidValue(),i._valueFlat[1].data=[],i._valueFlat[1].htmlNode.setAttribute("limit-selection",""),a[0].setAttribute("placeholder",""),a[1].setAttribute("placeholder",""),a[2].setAttribute("placeholder",""),a[0].firstElementChild.innerHTML=i.propertyPlaceholder,a[1].firstElementChild.innerHTML=i.operatorPlaceholder,a[2].firstElementChild.innerHTML=i.valuePlaceholder;var n=JSON.stringify(i._validValue);return void(i._oldValueAsString!==n&&(i._oldValueAsString=n,i.$.fireEvent("change",{value:JSON.parse(n)})))}if(e.classList.contains("jqx-filter-group")){if(t&&i._valueFlat.filter(function(t){return t.parentId===e.getAttribute("node-id")}).length>0)return;i._deleteElement(e,"group")}else i._deleteElement(e);i._generateValue(),i.$.scrollableContainer.refresh(),Array.from(i.$.contentContainer.children).forEach(function(e,t){var a=(t+1).toString();e.setAttribute("node-id",a),i._valueFlat.filter(function(t){return t.htmlNode===e})[0].nodeId=a,Array.from(e.children[1].children).forEach(function(e,t){var n=i._valueFlat.filter(function(t){return t.htmlNode===e})[0],r=a+"."+t;e.setAttribute("node-id",r),n.parentId=a,n.nodeId=r})})}}},{key:"_menuClosingHandler",value:function(e){var t=e.detail;"interaction"===t.trigger&&this._selectedElement===t.target&&e.preventDefault()}},{key:"_menuItemClickHandler",value:function(e){var t=this,i=t._selectedElement.closest(".jqx-filter-group-operator, .jqx-filter-nested-operator"),a=e.detail,n=a.value,r=void 0;if(i){i.innerHTML=t.localize(n)||a.label,i.value=n,r=i.classList.contains("jqx-filter-nested-operator")?i.getAttribute("node-id"):i.parentElement.getAttribute("node-id");for(var l=0;l<t._valueFlat.length;l++)if(t._valueFlat[l].nodeId===r){t._valueFlat[l].data=i.value;break}t._generateValue()}else r=t._selectedElement.parentElement.getAttribute("node-id"),t._addElement("group",null,n);t.$.scrollableContainer.refresh()}},{key:"_newFilterConditionRow",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=this,i=e[0],a=t._fields.find(function(e){return e.value===i}),n=a?a.label:void 0,r=void 0;if(void 0===i||!n&&"static"===t.fieldsMode)e.length=0;else{n||(a=t._getDynamicFieldInfo(i),n=a.label,e[0]=a.dataField);r=t._getFilterOperations(a).find(function(t){return t.value===e[1]}),r?r=r.label:e.splice(1,2)}var l=t._formatValueStringRepresentation(e[2],e[0],e[1]),o=document.createElement("div"),d='<div class ="filter-builder-item jqx-filter-field-name" '+(n?'><div class ="jqx-value-container">'+n:'placeholder><div class ="jqx-value-container">'+t.propertyPlaceholder)+'</div></div><div class ="filter-builder-item jqx-filter-operation" '+(r?'><div class ="jqx-value-container">'+r:'placeholder><div class ="jqx-value-container">'+t.operatorPlaceholder)+'</div></div><div class ="filter-builder-item jqx-filter-value" '+(void 0!==e[2]?'><div class ="jqx-value-container">'+l:'placeholder><div class ="jqx-value-container">'+t.valuePlaceholder)+'</div></div><div class ="jqx-filter-delete-btn"></div>';return o.className="jqx-filter-group-condition",o.innerHTML=d,e.length||o.setAttribute("limit-selection",""),o}},{key:"_formatValueStringRepresentation",value:function(e,t,i){var a=this,n=a._getFieldByFieldName(t),r=void 0;if(!n)return e;if(void 0===e||null===e)return a.valuePlaceholder;if(void 0!==i&&a.customOperations&&a.customOperations.length>0&&(i=a.customOperations.find(function(e){return e.name===i}))&&i.valueTemplate)return i.valueTemplate(a._editor,e);switch(n.dataType){case"date":case"datetime":e=e instanceof Date||"string"==typeof e||"number"==typeof e&&!isNaN(e)?new JQX.Utilities.DateTime(e):e,e.calendar.days=a._localizedDays,e.calendar.months=a._localizedMonths,e.calendar.locale=a.locale,r=e.toString("date"===n.dataType?a.formatStringDate:a.formatStringDateTime);break;case"array":r="string"==typeof e?e.split(","):e;break;case"object":r="string"==typeof e?e:JSON.stringify(e);break;case"number":r=e;break;case"boolean":r=!!e;break;default:r=e+""}return a.valueFormatFunction?a.valueFormatFunction(r,t,n.dataType||"string"):r}},{key:"_getFieldByFieldName",value:function(e){return Object.assign({},this._fields.find(function(t){return t.value===e}))}},{key:"_refresh",value:function(){var e=this;e._generateValue(),e._emptyElementsStructure(),e._generateHTMLStructureFromFlatValue(),e._restrictNesting()}},{key:"_generateValue",value:function(e){for(var t=this,i=[],a=t._valueFlat.slice(0),n=[],r=0;r<a.length;r++){var l=a[r],o={};"group"===l.type&&(o.nodeId=l.nodeId,o.parentId=l.parentId,o.data=l.data,o.structure=[],i.push(o))}for(var d=0;d<i.length;d++)for(var s=i[d],u=0;u<a.length;u++){var c=a[u];if(c.parentId===s.nodeId&&"condition"===c.type){var p=a[u-1];p&&p.parentId===s.nodeId&&"operator"===p.type&&s.structure.push(p.data.toString()),s.structure.push(c.data)}}i=i.filter(function(e){return e.structure.length>0}),i.sort(function(e,t){return t.nodeId.split(".").length-e.nodeId.split(".").length});for(var v=0;v<i.length;v++){(function(e){var t=i[e],a=i.filter(function(e){return e.nodeId===t.parentId})[0]
;a&&a.structure?a.structure.push(t.structure):"0"===t.nodeId?n=n.concat(t.structure):t.data&&(e>0&&n.push(t.data),n.push(t.structure))})(v)}if(t.value=n,t._validateValue(),t._validValue=t._getValidValue(),!e){var f=JSON.stringify(t._validValue);t._oldValueAsString!==f&&(t._oldValueAsString=f,t.$.fireEvent("change",{value:JSON.parse(f)}))}}},{key:"_getItemById",value:function(e,t){var i=this,a=i._valueFlat.filter(function(i){return t?i.parentId===e:i.nodeId===e});return a.length>0?a[0]:null}},{key:"_closeEditor",value:function(e){var t=this,i=void 0;if(t._editedItem&&t._editorIsOpen){var a=t._editedItem,n=t._editor.closest(".filter-builder-item"),r=n.querySelector(".jqx-value-container"),l=n.parentElement,o=l.children[2];if(t._editor===t.$.dateTimePickerEditor)(i=t._editor.value)&&(i=i.toDate());else if(t._editor===t.$.checkBoxEditor)i=t._editor.checked;else if(t._editor===t.$.customEditor){if(t._editor){var d=Array.from(t._editor.getElementsByTagName("jqx-numeric-text-box"));d.forEach(function(e){return e._inputBlurHandler()})}i=t._selectedCustomCondition.handleValue(t._editor)}else if(t._editor===t.$.numericTextBoxEditor)t._editor._inputBlurHandler(),i=t._editor.value;else if(n.classList.contains("jqx-filter-value")){var s=t._getFieldByFieldName(t._editedItem.data[0]);i="array"===s.dataType?t._editor.value.split(","):"object"===s.dataType?JSON.parse(t._editor.value):t._editor.value}else i=t._editor.value;if(n.classList.contains("jqx-filter-field-name")){if(""===i.trim())return void t._hideEditor(n,void 0===a.data[0]);l.hasAttribute("limit-selection")&&(l.removeAttribute("limit-selection"),l.parentElement.nextElementSibling.removeAttribute("limit-selection"));var u=t._fields.find(function(e){return e.label===i}),c=a.data[0];if(u)a.data[0]=u.value;else{if("dynamic"!==t.fieldsMode)return r.innerHTML=t._fields.find(function(e){return e.value===c}).label,void t._hideEditor(n);var p=t._getDynamicFieldInfo(i);i=p.label,a.data[0]=p.dataField}r.innerHTML=i,t._handleFieldChange([c,a.data[0]],[o,a,l])}else n.classList.contains("jqx-filter-operation")?t._handleOperationChange([a,i,t._editor.$.input.dataValue],[r,o]):(a.data[2]=i,r.innerHTML=t._formatValueStringRepresentation(i,t._editedItem.data[0],t._editedItem.data[1]));t._generateValue(e),t._hideEditor(n)}}},{key:"_getDynamicFieldInfo",value:function(e){var t=this,i={label:e,dataField:e,dataType:"string"};if(t.getDynamicField){var a=t.getDynamicField(e);a.label&&(i.label=a.label),a.dataField&&(i.dataField=a.dataField),a.dataType&&(i.dataType=a.dataType),a.filterOperations&&Array.isArray(a.filterOperations)&&a.filterOperations.length>0&&(i.filterOperations=a.filterOperations),a.lookup&&(i.lookup=a.lookup)}return t._manuallyAddedFields.push(i),t._mapFieldsToMenu(),i}},{key:"_handleFieldChange",value:function(e,t){var i=this,a=e[0],n=t[1],r=t[2],l=t[0],o=i._fields.find(function(t){return t.value===e[1]}),d=i._getFilterOperations(o);if(!a||void 0===n.data[1])return void i._handleOnlyOperation(d,n.data,r);var s=i._fields.find(function(e){return e.value===a}),u=s.dataType,c=o.dataType;if(o!==s&&(c!==u||o.filterOperations||s.filterOperations)){if(!!d.find(function(e){return e.value===n.data[1]})){if(c===u)return;return"date"===c&&"datetime"===u||"datetime"===c&&"date"===u?void(l.firstElementChild.innerHTML=i._formatValueStringRepresentation(n.data[2],n.data[0],n.data[1])):(n.data.splice(2,1),l.setAttribute("placeholder",""),void(l.firstElementChild.innerHTML=i.valuePlaceholder))}n.data.splice(1,2),r.children[1].setAttribute("placeholder",""),r.children[1].firstElementChild.innerHTML=i.operatorPlaceholder,l.setAttribute("placeholder",""),l.firstElementChild.innerHTML=i.valuePlaceholder,l.classList.remove("jqx-visibility-hidden"),i._handleOnlyOperation(d,n.data,r)}}},{key:"_handleOnlyOperation",value:function(e,t,i){if(1===e.length){var a=e[0];t[1]=a.value,i.children[1].removeAttribute("placeholder",""),i.children[1].firstElementChild.innerHTML=e[0].label,("isblank"===a.value||"isnotblank"===a.value||a.custom&&a.hideValue)&&(t.splice(2,1),i.children[2].classList.add("jqx-visibility-hidden"))}}},{key:"_handleOperationChange",value:function(e,t){var i=this,a=e[0],n=e[1],r=e[2],l=t[0],o=t[1],d=void 0!==a.data[1]?i._filterOperationDescriptions.find(function(e){return e.value===a.data[1]}):void 0,s=i._filterOperationDescriptions.find(function(e){return e.value===r}),u=s.value;s!==d&&(a.data[1]=u,l.innerHTML=n,"isblank"===u||"isnotblank"===u||s.custom&&s.hideValue?(a.data.splice(2,1),o.classList.add("jqx-visibility-hidden")):o.classList.contains("jqx-visibility-hidden")?(o.setAttribute("placeholder",""),o.classList.remove("jqx-visibility-hidden"),o.firstElementChild.innerHTML=i.valuePlaceholder):(s.custom||d&&d.custom)&&(a.data.splice(2,1),o.setAttribute("placeholder",""),o.firstElementChild.innerHTML=i.valuePlaceholder))}},{key:"_hideEditor",value:function(e,t){var i=this;t&&e.setAttribute("placeholder",""),e.removeAttribute("edited"),i.$.editorsContainer.removeAttribute("open"),i._editor.close&&i._editor.close(),i._editor.classList.add("jqx-hidden"),i._editorIsOpen=i._enterIsPressedInEditor=!1,i.$.scrollableContainer.refresh()}},{key:"_clickHandlerFilterButton",value:function(e,t,i){function a(e,t,i){n._contextMenuOptions=0===t.length?n._defaultFilterOperationDescriptions:t,n._handleContextMenu(e),n.$.conditionsMenu.opened&&(n.$.conditionsMenu._discardKeyboardHover(),n.$.conditionsMenu._hoverViaKeyboard(n.$.conditionsMenu.querySelector('jqx-menu-item[value="'+i+'"]')))}var n=this;if(!i.closest(".jqx-editors-container")){if(n._closeEditor(),n._editedItem=n._getItemById(t),e.contains("jqx-filter-add-btn"))return void a(i,n._groupOperationDescriptions);if(e.contains("jqx-filter-field-name")||n._editedItem.data&&n._editedItem.data.length)if(e.contains("jqx-filter-group-operator")||e.contains("jqx-filter-nested-operator"))a(i,n._groupOperationDescriptions,n._editedItem.data);else{var r=i.closest(".filter-builder-item");r.removeAttribute("placeholder"),n._openEditor(i)}}}},{key:"_handleContextMenu",value:function(e){var t=this;if(t._selectedElement===e&&t.$.conditionsMenu.opened)return void t.$.conditionsMenu.close();if(t._closeEditor(),t.disableContextMenu)return void(t._selectedElement=e);var i=e.getBoundingClientRect(),a=t.getBoundingClientRect(),n=i.left+t.$.contentContainer.scrollLeft-a.left,r=i.top+t.$.contentContainer.scrollTop-a.top+i.height;t.$.conditionsMenu.dataSource=t._contextMenuOptions,t.$.conditionsMenu.open(n,r+3),t._selectedElement=e,t.$.scrollableContainer.refresh()}},{key:"_openEditor",value:function(e){var t=this,i=e&&e.closest(".jqx-filter-group-condition")?e.closest(".jqx-filter-group-condition").getAttribute("node-id"):null,a=e.closest(".filter-builder-item"),n=t._getItemById(i),r="";void 0!==n.data[0]?r=n.data[0]:t._fields.length&&(r=t._fields[0].value);var l=t._getFieldByFieldName(r),o="",d=void 0,s=void 0;if(a.classList.contains("jqx-filter-field-name"))s=0,t._fields||t._mapFieldsToMenu(),l.lookup={dataSource:t._fields.slice(),readonly:!1},o=l.label||"",d=l.value;else if(a.classList.contains("jqx-filter-operation")){s=1;var u=t._getFilterOperations(l);l.lookup={dataSource:u,readonly:!0};var c=u.find(function(e){return e.value===n.data[s]})||u[0];o=c.label,d=c.value}else s=2,void 0===(o=n.data[s])&&(o="");t._editorIsOpen&&t._closeEditor(),a.setAttribute("edited",""),t._editedItem=n;var p=t._fields,v=p.filter(function(e){return e.value===r}),f=t._filterOperationDescriptions.filter(function(e){return e.value===n.data[1]&&e.custom}),m=v.length>0?v[0]:null,_=l.lookup&&l.lookup.dataSource?"lookup":m.dataType;2===s&&0!==f.length&&f[0].editorTemplate?(t._selectedCustomCondition=f[0],t._openCustomEditor(_,o,l)):t._openEditorByFieldType(_,o,l,d),setTimeout(function(){t._editor.focus(),t._editor!==t.$.numericTextBoxEditor&&t._editor!==t.$.textBoxEditor||(t.$.scrollableContainer.scrollLeft=t.$.scrollableContainer.$.scrollViewerContainer.scrollLeft,t.$.scrollableContainer.scrollTop=t.$.scrollableContainer.$.scrollViewerContainer.oldTop,t.$.scrollableContainer.$.scrollViewerContainer.scrollLeft=0,t.$.scrollableContainer.$.scrollViewerContainer.scrollTop=0,t._editor.$.input.selectionStart=t._editor.$.input.selectionEnd=t._editor.$.input.value.length),t.$.scrollableContainer.refresh()},0),t._editor.classList.remove("jqx-hidden"),t._editorIsOpen=!0,t.$.editorsContainer.setAttribute("open",""),a.appendChild(t.$.editorsContainer),t.$.scrollableContainer.refresh(),l.lookup&&l.lookup.readonly&&t._editor.open()}},{key:"_getFilterOperations",value:function(e){var t=this,i=t._filterOperationDescriptions.slice();if(e.filterOperations)i=t._filterOperationDescriptions.filter(function(t){return e.filterOperations.indexOf(t.value)>-1});else{var a=void 0;switch(e.dataType){case"date":case"datetime":case"number":a=["=","<>","<",">","<=",">=","isblank","isnotblank"];break;case"boolean":a=["=","<>","isblank","isnotblank"];break;case"object":a=["isblank","isnotblank"];break;case"string":a=["contains","notcontains","startswith","endswith","=","<>","isblank","isnotblank"];break;default:a=["contains","notcontains","startswith","endswith","=","<>","<",">","<=",">=","isblank","isnotblank"]}i=t._filterOperationDescriptions.filter(function(e){return a.indexOf(e.value)>-1})}return t.showIcons&&i.map(function(e){return e.icon=t.icons[e.value]}),i}},{key:"_openCustomEditor",value:function(e,t,i){var a=this,n=a.customOperations[a._selectedCustomCondition.index].editorTemplate(e,t,i);a.$.customEditor.innerHTML="",n&&a.$.customEditor.appendChild(n),a._editor=a.$.customEditor}},{key:"_openEditorByFieldType",value:function(e,t,i,a){var n=this;switch(e){case"boolean":n._initializeEditor("checkBox"),n._editor.checked=!!t;break;case"date":case"datetime":n._initializeEditor("dateTimePicker"),n._editor.formatString="date"===e?n.formatStringDate:n.formatStringDateTime,n._editor.value=t;break;case"number":n._initializeEditor("numericTextBox"),n._editor.value=t||0;break;default:n._initializeEditor("input"),n._editor.dropDownWidth="auto","lookup"===e?(n._editor.dataSource=i.lookup.dataSource,n._editor.dropDownAppendTo=n.$.container,n._editor.dropDownButtonPosition="right",n._editor.readonly=!!i.lookup.readonly):(n._editor.dataSource=[],n._editor.dropDownButtonPosition="none",n._editor.readonly=!1),"object"===e?n._editor.value=JSON.stringify(t||{}):(""===t&&n._editor.readonly&&(t=i.lookup.dataSource[0].label||""),n._editor.value=t+"",a&&(n._editor.$.input.dataValue=a))}}},{key:"_initializeEditor",value:function(e){var t=this;if(t.$[e+"Editor"])return void(t._editor=t.$[e+"Editor"]);var i=document.createElement("jqx-"+JQX.Utilities.Core.toDash(e));"numericTextBox"===e?(i.spinButtons=!0,i.inputFormat="floatingPoint"):"dateTimePicker"===e&&(i.dropDownAppendTo=t.$.container,i.calendarButton=!0,i.dropDownDisplayMode="auto",i.enableMouseWheelAction=!0,i.locale=t.locale,i.messages[t.locale]||(i.messages[t.locale]={}),i.messages[t.locale].dateTabLabel=t.localize("dateTabLabel"),i.messages[t.locale].timeTabLabel=t.localize("timeTabLabel")),i.theme=t.theme,i.animation=t.animation,i.$.addClass("jqx-hidden underlined"),t.$.editorsContainer.appendChild(i),t._editor=t.$[e+"Editor"]=i}},{key:"_getValidValue",value:function(){var e=this,t=e.properties.value.value,i=[],a=!1;return t.forEach(function(t){if(Array.isArray(t)){var n=!1,r=!1,l=[];t.forEach(function(t){if(Array.isArray(t)){var i=t[0],a=t[1],o=t[2];if(void 0===i||void 0===a)return void(r=!0);if(void 0!==o||"isblank"===a||"isnotblank"===a)return n=!0,void l.push(t);var d=e._filterOperationDescriptions.find(function(e){return e.value===a});d.custom&&d.hideValue?(n=!0,l.push(t)):r=!0}else r?r=!1:l.push(t)}),n?("string"==typeof l[l.length-1]&&l.pop(),i.push(l)):a=!0}else a?a=!1:i.push(t)}),"string"==typeof i[i.length-1]&&i.pop(),i}}],[{key:"properties",get:function(){return{allowDrag:{value:!1,type:"boolean"},applyMode:{allowValues:["immediately","change"],value:"change",type:"string"},customOperations:{value:[],type:"array",reflectToAttribute:!1},fields:{value:null,type:"array?",reflectToAttribute:!1},fieldsMode:{value:"dynamic",allowedValues:["dynamic","static"],type:"string"},formatStringDate:{value:"dd-MMM-yy",type:"string"},formatStringDateTime:{value:"dd-MMM-yy HH:mm:ss",type:"string"},getDynamicField:{value:null,type:"function?"},icons:{value:{"=":"equals","<>":"notequals",">":"greaterthan",">=":"greaterthanorequal","<":"lessthan","<=":"lessthanorequal",startswith:"startswith",endswith:"endswith",contains:"contains",notcontains:"notcontains",isblank:"isblank",isnotblank:"isnotblank"},type:"object",reflectToAttribute:!1},messages:{value:{en:{add:"Add",addCondition:"Add Condition",addGroup:"Add Group",and:"And",notand:"Not And",or:"Or",notor:"Not Or","=":"Equals","<>":"Does not equal",">":"Greater than",">=":"Greater than or equal to","<":"Less than","<=":"Less than or equal to",startswith:"Starts with",endswith:"Ends with",contains:"Contains",notcontains:"Does not contain",isblank:"Is blank",isnotblank:"Is not blank",wrongParentGroupIndex:'{{elementType}}: Wrong parent group index in "{{method}}" method.',wrongElementNode:'{{elementType}}: Incorect node / node Id in "{{method}}" method.',invalidDataStructure:"{{elementType}}: Used invalid data structure in updateCondition/updateGroup method.",dateTabLabel:"DATE",timeTabLabel:"TIME",queryLabel:"Query"}},type:"object",extend:!0},operatorPlaceholder:{value:"Operator",type:"string"},propertyPlaceholder:{value:"Property",type:"string"},showIcons:{value:!1,type:"boolean"},value:{value:[],type:"array?",reflectToAttribute:!1},valueFormatFunction:{value:null,type:"function?",reflectToAttribute:!1},valuePlaceholder:{value:"Value",type:"string"}}}},{key:"requires",get:function(){var e={"JQX.Button":"jqxbutton.js","JQX.Calendar":"jqxcalendar.js","JQX.CheckBox":"jqxcheckbox.js","JQX.DateTimePicker":"jqxdatetimepicker.js","JQX.DropDownList":"jqxdropdownlist.js","JQX.Input":"jqxinput.js","JQX.ListBox":"jqxlistbox.js","JQX.Menu":"jqxmenu.js","JQX.NumericTextBox":"jqxnumerictextbox.js","JQX.ScrollBar":"jqxscrollbar.js","JQX.TimePicker":"jqxtimepicker.js","JQX.Tooltip":"jqxtooltip.js","JQX.Utilities.BigNumber":"jqxmath.js","JQX.Utilities.DateTime":"jqxdate.js","JQX.Utilities.Draw":"jqxdraw.js","JQX.Utilities.NumericProcessor":"jqxnumeric.js"};return window.NIComplex||(e["JQX.Utilities.Complex"]="jqxcomplex.js"),e}},{key:"listeners",get:function(){return{down:"_downHandler",move:"_moveHandler",resize:"_resizeHandler","editorsContainer.keydown":"_innerContainerKeydownHandler","conditionsMenu.closing":"_menuClosingHandler","conditionsMenu.itemClick":"_menuItemClickHandler","contentContainer.change":"_contentContainerChangeHandler","document.down":"_documentDownHandler","document.move":"_documentMoveHandler","document.up":"_documentUpHandler"}}}]),t}(JQX.BaseElement));
//# sourceMappingURL=jqxfilterbuilder.js.map
